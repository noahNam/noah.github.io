---
layout: post
title: Aggregate Root
description: >
    애그리거트 루트
sitemap: false
hide_last_modified: false
categories:
  - category
  - DDD
---


# Aggregate Root

* toc
{:toc .large-only}

## 상위모델 관계도
![상위 모델 관계도](/assets/img/posts/ddd/주문관계.png)
- 온라인 쇼핑몰 시스템을 개발할 때 위의 `도메인 관계도`와 같이 상위 수준 개념을 이용해서 전체 모델을 정리하면 도메인 관계를 이해하는데 도움이 된다.
- 해당 관계도는 회원, 상품, 결제와 관련이 있다는 것을 쉽게 알 수 있다.

## 객체수준 모델
![객체수준모델](/assets/img/posts/ddd/개별객체수준.png)
- `상위 모델 관계도`의 상위 수준 모델을 개별 객체 단위로 나타낸 그림이다.
- `객체수준 모델`을 `상위 모델 관계도` 에 대한 이해 없이 파악하려면 오랜시간이 걸린다.
- 도메인에서 객체 모델이 복잡해지면 개별 구성요소 위주로 모델을 이해하게 되고 전반적인 구조나 큰 수준에서 도메인 간의 관계를 파악하기 힘들어진다.
  - 이렇게 세부적인 모델만 이해한 상태로는 코드를 수정하는 것이 꺼려지기 때문에 코드 변경을 최대한 회피하는 쪽으로 요구사항을 협의하게 된다.
- 이렇게 `복잡한 도메인을 이해하고 관리하기 쉬운 단위로 만들려면 상위 수준에서 모델을 조망할 수 있는 방법이 필요한데, 그 방법이 바로 애그리거트`이다.

## Aggregate
![Aggregate](/assets/img/posts/ddd/Aggregate.png)
- 위 그림은 `객체 수준 모델`을 애그리거트 단위로 묶어서 다시 표현한 것이다. 동일한 모델이지만 애그리거트를 사용하여 모델 간의 관계를 개별 모델 수준과 상위 수준에서 모두 이해할 수 있다.
- 애그리거트는 모델의 이해에 대한 도움뿐만 아니라, 일관성을 관리하는 기준도 된다.
- 애그리거트 단위로 일관성을 관리하기 때문에 애그리거트는 복잡한 도메인을 단순한 구조로 만들어준다.
- `애그리거트는 관련된 모델을 하나로 모았기 때문에 한 애그리거트에 속한 객체는 동일한 라이프 사이클을 갖는다.`
  - 주문 애그리거트를 만들려면 Order, OrderLine, Orderer와 같은 객체를 함께 생성해야 한다.
  - Orderer는 생성했는데 ShppingInf는 만들지 않거나 ShippingInfo를 생성하면서 Orderer를 생성하지 않는 경우는 없다.
  - `이렇게 도메인 규칙에 따라 최초 주문 시점에 일부 객체를 만들 필요가 없는 경우도 있지만 애그리거트에 속한 구성요소는 대부분 함께 생성하고 함께 제거된다.`

### Aggregate 경계
- 애그리거트는 경계를 갖는다.
  - 한 애그리거트에 속한 객체는 다른 애그리거트에 속하지 않는다.
  - `애그리거트는 독립된 객체 군이며 각 애그리거트는 자기 자신을 관리할 뿐 다른 애그리거트를 관리하지 않는다.`
  - 예를 들어 주문 애그리거트는 배송지를 변경등은 자신이 관리하지만, 주문 애그리거트에서 회원의 비밀번호를 변경하거나 상품의 가격을 변경하지는 앟는다.
- 경계를 설정할 때 기본이 되는 것은 도메인 규칙과 요구사항이다.
  - 도메인 규칙에 따라 함께 생성되는 구성요소는 한 애그리거트에 속할 가능성이 높다.
  - 예를 들어 주문할 상품 갯수, 배송지 정보, 주문자 정보는 주문 시점에 함께 생성되므로 이들은 한 애그리거트에 속한다.
  - 다른 예로 OrderLine의 주문상품 갯수를 변경하면 도메인 규칙에 따라 Order의 총 주문 금액을 새로 계산해야 한다. 이렇게 함께 변경되는 빈도가 높은 객체는 한 애그리거트에 속할 가능성이 높다.

### Product와 Review로 보는 Aggreate
- 상품 상세 페이지에 들어가면 상품 상세 정보와 함께 리뷰 내용을 보여줘야 한다는 요구사항이 있을 때 `Product`엔티티와 `Review`엔티티는 같은 애그리거트에 속한다고 생각할 수 있다.
- 하지만 `Product`와 `Review`는 함께 생성되지 않고, 함께 변경되지도 않는다.
- 또한, `Proeuct`를 변경하는 주체는 관리자이지만 `Review`를 생성하고 변경하는 주체는 고객이다.
![.](/assets/img/posts/ddd/Aggreate경계.png)
- `Review`의 변경이 `Product`에 영향을 주지않고 반대의 경우도 마찬가지이므로 이 둘은 서로 다른 애그리거트로 볼 수 있다.
- 처음 도메인 모델을 만들기 시작하면 큰 애그리거트로 보이는 것들이 많지만, 도메인에 대한 경험이 생기면 애그리거트의 실제 크기는 줄어든다.
  - `경험이 쌓일수록 다수의 애그리거트가 한 개의 엔티티 객체만 갖는 경우가 많고, 두 개 이상의 엔티티로 구성되는 애그리거트는 드물어진다고 한다.`